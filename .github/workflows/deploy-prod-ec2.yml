# Deploys the NestJS app to AWS EC2 on every push to the prod branch.
# Required GitHub secrets:
#   EC2_HOST           - EC2 instance hostname or IP (e.g. ec2-xx-xx-xx-xx.compute.amazonaws.com)
#   EC2_SSH_PRIVATE_KEY - PEM content of the SSH key used to connect to the instance
#   PROD_ENV            - Contents of your .env file for production (DB_*, JWT_SECRET, MAIL_*, etc.)
# Optional:
#   EC2_USER           - SSH user (default: ec2-user)
# On the EC2 instance: create ~/apps, ensure Node.js 20+ and optionally PM2 are installed.
name: Deploy prod to AWS EC2

on:
  push:
    branches:
      - prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Configure SSH
        env:
          SSH_KEY_RAW: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          SSH_KEY_B64: ${{ secrets.EC2_SSH_PRIVATE_KEY_BASE64 }}
        run: |
          mkdir -p ~/.ssh
          if [ -n "$SSH_KEY_B64" ]; then
            echo "$SSH_KEY_B64" | base64 -d > ~/.ssh/deploy_key
          else
            printf '%s' "$SSH_KEY_RAW" | sed 's/\r$//' > ~/.ssh/deploy_key
          fi
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          PROD_ENV: ${{ secrets.PROD_ENV }}
        run: |
          SSH_OPTS="-i ~/.ssh/deploy_key -o StrictHostKeyChecking=no"
          TARGET="${EC2_USER:-ec2-user}@${EC2_HOST}"
          ssh $SSH_OPTS ${TARGET} 'mkdir -p ~/apps/dist'
          test -f dist/main.js || (echo "::error::Build did not produce dist/main.js" && ls -la dist/ && exit 1)
          # Write deployment manifest (commit + time) so you can verify what is running on EC2
          echo "COMMIT_SHA=${{ github.sha }}" > DEPLOYED.txt
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> DEPLOYED.txt
          echo "BRANCH=${{ github.ref_name }}" >> DEPLOYED.txt
          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> DEPLOYED.txt
          # Sync built output, package files, and deployment manifest
          rsync -avz --delete -e "ssh $SSH_OPTS" dist/ ${TARGET}:~/apps/dist/
          rsync -avz -e "ssh $SSH_OPTS" package.json package-lock.json DEPLOYED.txt ${TARGET}:~/apps/
          # Write .env on server from secret (so app can connect to DB, etc.)
          if [ -z "$PROD_ENV" ]; then
            echo "::warning::PROD_ENV secret is not set â€” app may fail to connect to DB. Add repo secret PROD_ENV with your .env contents."
          else
            printf '%s' "$PROD_ENV" > .env.deploy
            scp $SSH_OPTS .env.deploy ${TARGET}:~/apps/.env
            rm -f .env.deploy
          fi
          # Install prod deps and restart on EC2
          ssh $SSH_OPTS ${TARGET} 'bash -s' << 'REMOTE'
            set -e
            cd ~/apps
            npm ci --omit=dev
            # Use absolute path so PM2 finds the script regardless of cwd
            MAIN_SCRIPT="$HOME/apps/dist/main.js"
            if [ ! -f "$MAIN_SCRIPT" ]; then
              echo "::error::Deployed script not found at $MAIN_SCRIPT"
              echo "Contents of ~/apps:"
              ls -la ~/apps || true
              echo "Contents of ~/apps/dist:"
              ls -la ~/apps/dist 2>/dev/null || true
              exit 1
            fi
            if command -v pm2 >/dev/null 2>&1; then
              pm2 delete ecommerce 2>/dev/null || true
              pm2 start "$MAIN_SCRIPT" --name ecommerce
              pm2 save
            else
              (pkill -f "node dist/main" || true)
              nohup node "$MAIN_SCRIPT" > app.log 2>&1 &
            fi
          REMOTE
          # Log deployed version and app process on EC2
          echo "Deployed to EC2 (verify with: cat ~/apps/DEPLOYED.txt on the server):"
          cat DEPLOYED.txt
          echo ""
          echo "App process on EC2:"
          ssh $SSH_OPTS ${TARGET} 'bash -s' << 'REMOTE'
            if command -v pm2 >/dev/null 2>&1; then
              pm2 list
              pm2 jlist 2>/dev/null | grep -E '"pid"|"name"' || true
            else
              echo "PID(s) for node dist/main:"
              pgrep -af "node dist/main" || echo "(none found)"
            fi
          REMOTE

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
